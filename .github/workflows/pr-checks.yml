name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check conventional commits
      uses: wagoid/commitlint-github-action@9763196e10f27aef304c9b8b660d31d97fce0f99 # v5
      with:
        configFile: .commitlintrc.json
        
    - name: Build project
      run: npm run build
        
    - name: Run tests with coverage
      run: npm run test:coverage
      
    - name: Check bundle size
      run: |
        npm run build
        BUNDLE_SIZE=$(du -sh dist/ | cut -f1)
        echo "Bundle size: $BUNDLE_SIZE"
        
        # Warn if bundle is unusually large (>5MB)
        SIZE_BYTES=$(du -sb dist/ | cut -f1)
        if [ $SIZE_BYTES -gt 5242880 ]; then
          echo "‚ö†Ô∏è Warning: Bundle size is larger than 5MB"
        fi
        
    - name: Validate package.json
      run: |
        # Check if version in package.json is valid
        VERSION=$(node -p "require('./package.json').version")
        echo "Package version: $VERSION"
        
        # Validate semantic version format
        if ! echo "$VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
          echo "‚ùå Invalid semantic version format"
          exit 1
        fi
        
        # Smart NPM version validation with suggestions
        echo "üîç Checking NPM registry for version conflicts..."
        
        # Get current latest version from NPM
        LATEST_VERSION=$(npm view @neublink/gitplus version 2>/dev/null || echo "none")
        echo "Current package.json version: $VERSION"
        echo "Latest NPM version: $LATEST_VERSION"
        
        # Check if current version already exists
        if npm view @neublink/gitplus@$VERSION version 2>/dev/null; then
          echo ""
          echo "‚ùå ERROR: Version $VERSION already exists on NPM"
          echo "Cannot publish duplicate versions."
          echo ""
          
          if [ "$LATEST_VERSION" != "none" ]; then
            # Parse version numbers for suggestions
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
            NEXT_PATCH="$MAJOR.$MINOR.$((PATCH + 1))"
            NEXT_MINOR="$MAJOR.$((MINOR + 1)).0"
            NEXT_MAJOR="$((MAJOR + 1)).0.0"
            
            echo "üí° Suggested version updates from $LATEST_VERSION:"
            echo "   ‚Ä¢ Patch (bug fixes): $NEXT_PATCH"
            echo "   ‚Ä¢ Minor (new features): $NEXT_MINOR"
            echo "   ‚Ä¢ Major (breaking changes): $NEXT_MAJOR"
          fi
          
          echo ""
          echo "To fix this:"
          echo "1. Update version in package.json to an available version"
          echo "2. Commit the version change"
          echo "3. Push to update this PR"
          exit 1
          
        elif [ "$LATEST_VERSION" != "none" ]; then
          # Version doesn't exist, but validate it's a reasonable increment
          echo "üîç Comparing versions: $VERSION vs $LATEST_VERSION"
          
          # Safe version comparison function
          compare_versions() {
            local pkg_ver="$1"
            local npm_ver="$2"
            
            # Extract base version (remove pre-release and build metadata)
            local pkg_base=$(echo "$pkg_ver" | sed 's/-.*$//' | sed 's/+.*$//')
            local npm_base=$(echo "$npm_ver" | sed 's/-.*$//' | sed 's/+.*$//')
            
            # Parse version components
            IFS='.' read -r pkg_major pkg_minor pkg_patch <<< "$pkg_base"
            IFS='.' read -r npm_major npm_minor npm_patch <<< "$npm_base"
            
            # Validate components are numeric and within safe limits
            for component in "$pkg_major" "$pkg_minor" "$pkg_patch" "$npm_major" "$npm_minor" "$npm_patch"; do
              # Check if component is numeric using case statement (more portable)
              case "$component" in
                ''|*[!0-9]*)
                  echo "‚ö†Ô∏è Invalid version component: $component"
                  return 2  # Cannot compare
                  ;;
              esac
              if [ "$component" -ge 1000 ]; then
                echo "‚ö†Ô∏è Version component >= 1000 not supported: $component"
                return 2  # Cannot compare
              fi
            done
            
            # Safe arithmetic comparison (all components < 1000)
            local pkg_num=$((pkg_major * 1000000 + pkg_minor * 1000 + pkg_patch))
            local npm_num=$((npm_major * 1000000 + npm_minor * 1000 + npm_patch))
            
            if [ $pkg_num -gt $npm_num ]; then
              return 0  # Package version is newer
            elif [ $pkg_num -eq $npm_num ]; then
              return 1  # Versions are equal
            else
              return 3  # Package version is older
            fi
          }
          
          # Perform safe version comparison
          compare_versions "$VERSION" "$LATEST_VERSION"
          comparison_result=$?
          
          case $comparison_result in
            0)
              echo "‚úÖ Version $VERSION is newer than $LATEST_VERSION"
              ;;
            1)
              echo "‚ö†Ô∏è Version $VERSION equals latest NPM version $LATEST_VERSION"
              echo "This might indicate the comparison logic needs review."
              ;;
            2)
              echo "‚ö†Ô∏è Cannot compare versions (unsupported format or large numbers)"
              echo "Skipping version order validation - manual review recommended"
              ;;
            3)
              echo ""
              echo "‚ö†Ô∏è WARNING: Version $VERSION is older than latest NPM version $LATEST_VERSION"
              echo "This might not be what you intended."
              echo ""
              echo "Consider using a higher version number."
              # Don't fail, just warn - might be intentional
              ;;
          esac
          
          echo "‚úÖ Version $VERSION is available for publishing"
        else
          echo "‚úÖ Version $VERSION is available for publishing (first publication)"
        fi
        
    - name: Check documentation
      run: |
        # Ensure README has been updated for significant changes
        if git diff --name-only origin/main...HEAD | grep -E '\.(ts|js)$' | head -1; then
          echo "Code changes detected"
          if ! git diff --name-only origin/main...HEAD | grep -q "README.md"; then
            echo "‚ö†Ô∏è Consider updating README.md for code changes"
          fi
        fi
        
    - name: Test CLI help outputs
      run: |
        npm run build
        node dist/cli.js --help > cli-help.txt
        
        # Ensure all 13 tools are documented in help
        COMMAND_COUNT=$(grep -E "^\s+(commit|ship|analyze|suggest|status|sync|stash|reset|rebase|recover|validate)" cli-help.txt | wc -l)
        echo "Commands found in help: $COMMAND_COUNT"
        
        if [ $COMMAND_COUNT -lt 11 ]; then
          echo "‚ùå Some commands missing from CLI help"
          cat cli-help.txt
          exit 1
        fi
        
    - name: Validate npm publish readiness
      run: |
        npm run build
        
        # Test that package can be packed without errors
        npm pack --dry-run
        echo "‚úÖ Package can be packed successfully"
        
        # Validate package.json for NPM publishing
        node -e "
          const pkg = require('./package.json');
          if (!pkg.name || !pkg.version || !pkg.description) {
            console.error('‚ùå Missing required package.json fields');
            process.exit(1);
          }
          if (!pkg.main || !pkg.bin) {
            console.error('‚ùå Missing main or bin fields in package.json');
            process.exit(1);
          }
          console.log('‚úÖ Package.json is valid for publishing');
        "
        
    - name: Test git tag creation
      run: |
        # Get current version from package.json
        VERSION=$(node -p "require('./package.json').version")
        TEST_TAG="test-v$VERSION-pr-check"
        
        # Check if the actual version tag already exists on remote
        if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION$"; then
          echo "‚ö†Ô∏è Warning: Tag v$VERSION already exists on remote"
          echo "Publishing this version may require manual tag cleanup"
        fi
        
        # Test that we can create and delete a test tag
        git tag "$TEST_TAG" 2>/dev/null || {
          echo "‚ùå Cannot create git tag"
          exit 1
        }
        
        git tag -d "$TEST_TAG" 2>/dev/null || {
          echo "‚ùå Cannot delete git tag"
          exit 1
        }
        
        echo "‚úÖ Git tag creation works correctly"

  compatibility-check:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [18.x, 20.x]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build and test
      run: |
        npm run build
        npm run test
        
    - name: Test package installation
      run: |
        npm pack
        PACKAGE=$(ls *.tgz)
        npm install -g "$PACKAGE"
        
        # Test basic CLI functionality
        gitplus --version || echo "CLI version check completed"
        gitplus --help | head -20