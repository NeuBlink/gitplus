name: AI Merge Decider

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop, 'release/*']

# Ensure only one merge decision runs per PR
concurrency:
  group: merge-decider-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: read
  actions: read
  id-token: write

jobs:
  # AI-powered merge decision that waits for all CI checks to complete
  ai-merge-decision:
    runs-on: ubuntu-latest
    # Run automatically when PR is updated - no needs dependency since jobs are in different workflows
    
    permissions:
      contents: read
      pull-requests: write
      checks: read
      actions: read
      id-token: write
      
    steps:
      - name: Wait for required CI workflows to complete
        run: |
          echo "üîÑ Waiting for CI workflows to complete..."
          
          # Function to check if a workflow run has completed
          check_workflow_status() {
            local workflow_name="$1"
            echo "Checking status of $workflow_name..."
            
            # Get the latest run for this workflow on this PR
            gh run list --repo ${{ github.repository }} \
              --workflow "$workflow_name" \
              --json status,conclusion,headSha \
              --jq ".[] | select(.headSha == \"${{ github.event.pull_request.head.sha }}\") | {status: .status, conclusion: .conclusion}" \
              | head -1
          }
          
          # Wait for workflows with timeout
          timeout=600  # 10 minutes
          interval=15  # Check every 15 seconds
          elapsed=0
          
          required_workflows=("CI" "PR Checks" "Claude Code Review")
          
          while [ $elapsed -lt $timeout ]; do
            all_complete=true
            
            for workflow in "${required_workflows[@]}"; do
              status_info=$(check_workflow_status "$workflow")
              
              if [ -z "$status_info" ]; then
                echo "‚è≥ Workflow '$workflow' not found or not started yet"
                all_complete=false
                continue
              fi
              
              status=$(echo "$status_info" | jq -r '.status // empty')
              conclusion=$(echo "$status_info" | jq -r '.conclusion // empty')
              
              if [ "$status" != "completed" ]; then
                echo "‚è≥ Workflow '$workflow' still running (status: $status)"
                all_complete=false
              else
                echo "‚úÖ Workflow '$workflow' completed (conclusion: $conclusion)"
              fi
            done
            
            if [ "$all_complete" = true ]; then
              echo "üéâ All required workflows have completed!"
              break
            fi
            
            echo "‚è≥ Waiting ${interval}s before next check... (${elapsed}s/${timeout}s elapsed)"
            sleep $interval
            elapsed=$((elapsed + interval))
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "‚ö†Ô∏è Timeout waiting for workflows to complete"
            echo "Proceeding with available information..."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for comprehensive analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Collect comprehensive context for AI analysis
        id: collect-context
        run: |
          # Create context directory
          mkdir -p .github/context
          
          echo "üîç Collecting comprehensive PR context for AI analysis..."
          
          # Collect basic PR information
          echo "=== PR INFORMATION ===" > .github/context/pr-info.txt
          echo "PR Number: ${{ github.event.pull_request.number }}" >> .github/context/pr-info.txt
          echo "Title: ${{ github.event.pull_request.title }}" >> .github/context/pr-info.txt
          echo "Author: ${{ github.event.pull_request.user.login }}" >> .github/context/pr-info.txt
          echo "Author Association: ${{ github.event.pull_request.author_association }}" >> .github/context/pr-info.txt
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}" >> .github/context/pr-info.txt
          echo "Head Branch: ${{ github.event.pull_request.head.ref }}" >> .github/context/pr-info.txt
          echo "Files Changed: ${{ github.event.pull_request.changed_files }}" >> .github/context/pr-info.txt
          echo "Additions: ${{ github.event.pull_request.additions }}" >> .github/context/pr-info.txt
          echo "Deletions: ${{ github.event.pull_request.deletions }}" >> .github/context/pr-info.txt
          echo "Draft: ${{ github.event.pull_request.draft }}" >> .github/context/pr-info.txt
          echo "" >> .github/context/pr-info.txt
          
          # Get PR description
          echo "=== PR DESCRIPTION ===" >> .github/context/pr-info.txt
          echo '${{ github.event.pull_request.body }}' >> .github/context/pr-info.txt
          echo "" >> .github/context/pr-info.txt
          
          # Collect commit information
          echo "=== COMMITS ===" > .github/context/commits.txt
          git log --oneline ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} >> .github/context/commits.txt || echo "Could not get commits" >> .github/context/commits.txt
          echo "" >> .github/context/commits.txt
          
          # Collect file changes
          echo "=== FILE CHANGES ===" > .github/context/file-changes.txt
          git diff --name-status ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} >> .github/context/file-changes.txt || echo "Could not get file changes" >> .github/context/file-changes.txt
          echo "" >> .github/context/file-changes.txt
          
          # Get diff stats
          echo "=== DIFF STATISTICS ===" >> .github/context/file-changes.txt
          git diff --stat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} >> .github/context/file-changes.txt || echo "Could not get diff stats" >> .github/context/file-changes.txt
          echo "" >> .github/context/file-changes.txt

      - name: Collect CI workflow results from GitHub API
        run: |
          echo "=== CI WORKFLOW RESULTS ===" > .github/context/ci-results.txt
          echo "Collected from GitHub API for commit ${{ github.event.pull_request.head.sha }}" >> .github/context/ci-results.txt
          echo "" >> .github/context/ci-results.txt
          
          # Get workflow run results
          workflows=("CI" "PR Checks" "Claude Code Review")
          overall_status="PASS"
          failed_workflows=()
          
          for workflow in "${workflows[@]}"; do
            echo "Checking workflow: $workflow" >> .github/context/ci-results.txt
            
            # Get the latest run for this workflow
            run_info=$(gh run list --repo ${{ github.repository }} \
              --workflow "$workflow" \
              --json status,conclusion,headSha \
              --jq ".[] | select(.headSha == \"${{ github.event.pull_request.head.sha }}\") | {status: .status, conclusion: .conclusion}" \
              | head -1)
            
            if [ -z "$run_info" ]; then
              echo "  Status: NOT_FOUND" >> .github/context/ci-results.txt
              overall_status="FAIL"
              failed_workflows+=("$workflow (not found)")
            else
              status=$(echo "$run_info" | jq -r '.status // "unknown"')
              conclusion=$(echo "$run_info" | jq -r '.conclusion // "unknown"')
              
              echo "  Status: $status" >> .github/context/ci-results.txt
              echo "  Conclusion: $conclusion" >> .github/context/ci-results.txt
              
              if [ "$conclusion" != "success" ]; then
                overall_status="FAIL"
                failed_workflows+=("$workflow ($conclusion)")
              fi
            fi
            echo "" >> .github/context/ci-results.txt
          done
          
          echo "=== OVERALL ASSESSMENT ===" >> .github/context/ci-results.txt
          echo "Overall CI Status: $overall_status" >> .github/context/ci-results.txt
          
          if [ "$overall_status" = "FAIL" ]; then
            echo "Failed workflows:" >> .github/context/ci-results.txt
            for failed in "${failed_workflows[@]}"; do
              echo "  - $failed" >> .github/context/ci-results.txt
            done
          fi
          
          # Export for use in AI prompt
          echo "CI_OVERALL_STATUS=$overall_status" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Collect Claude Code review findings
        run: |
          echo "=== CLAUDE CODE REVIEW ANALYSIS ===" > .github/context/claude-review-analysis.txt
          
          # Get Claude Code Review workflow result
          claude_run_info=$(gh run list --repo ${{ github.repository }} \
            --workflow "Claude Code Review" \
            --json status,conclusion,headSha \
            --jq ".[] | select(.headSha == \"${{ github.event.pull_request.head.sha }}\") | {status: .status, conclusion: .conclusion}" \
            | head -1)
          
          if [ -n "$claude_run_info" ]; then
            status=$(echo "$claude_run_info" | jq -r '.status // "unknown"')
            conclusion=$(echo "$claude_run_info" | jq -r '.conclusion // "unknown"')
            echo "Claude Review Workflow Status: $status" >> .github/context/claude-review-analysis.txt
            echo "Claude Review Workflow Conclusion: $conclusion" >> .github/context/claude-review-analysis.txt
          else
            echo "Claude Review Workflow: NOT_FOUND" >> .github/context/claude-review-analysis.txt
          fi
          echo "" >> .github/context/claude-review-analysis.txt
          
          # Get Claude Code review comments
          if command -v gh &> /dev/null; then
            echo "Fetching Claude Code review comments..." >> .github/context/claude-review-analysis.txt
            
            # Get PR reviews from Claude
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
              --jq '.[] | select(.user.login | test("claude|github-actions")) | {state: .state, body: .body, submitted_at: .submitted_at}' \
              > .github/context/claude-review.json 2>/dev/null || echo "[]" > .github/context/claude-review.json
            
            # Get issue comments from Claude  
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
              --jq '.[] | select(.user.login | test("claude|github-actions")) | {body: .body, created_at: .created_at}' \
              > .github/context/claude-comments.json 2>/dev/null || echo "[]" > .github/context/claude-comments.json
            
            # Analyze Claude review sentiment
            if [ -s .github/context/claude-review.json ] && [ "$(cat .github/context/claude-review.json)" != "[]" ]; then
              echo "‚úÖ Claude Code review found" >> .github/context/claude-review-analysis.txt
              
              # Check if Claude review indicates issues
              if jq -r '.[].body' .github/context/claude-review.json 2>/dev/null | grep -qi "not.*recommend\|concern\|issue\|problem\|fix.*needed\|should.*not\|‚ùå\|‚ö†Ô∏è\|blocking"; then
                echo "‚ö†Ô∏è Claude Code review indicates concerns or issues" >> .github/context/claude-review-analysis.txt
                echo "CLAUDE_SENTIMENT=negative" >> $GITHUB_ENV
              elif jq -r '.[].body' .github/context/claude-review.json 2>/dev/null | grep -qi "looks good\|approved\|ready\|‚úÖ\|well done\|recommend.*merg"; then
                echo "‚úÖ Claude Code review appears positive" >> .github/context/claude-review-analysis.txt
                echo "CLAUDE_SENTIMENT=positive" >> $GITHUB_ENV
              else
                echo "‚ÑπÔ∏è Claude Code review is neutral" >> .github/context/claude-review-analysis.txt
                echo "CLAUDE_SENTIMENT=neutral" >> $GITHUB_ENV
              fi
            else
              echo "‚ÑπÔ∏è No Claude Code review found" >> .github/context/claude-review-analysis.txt
              echo "CLAUDE_SENTIMENT=none" >> $GITHUB_ENV
            fi
          else
            echo "GitHub CLI not available, skipping Claude review collection" >> .github/context/claude-review-analysis.txt
            echo "CLAUDE_SENTIMENT=unknown" >> $GITHUB_ENV
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: AI Merge Decision Analysis
        id: merge-decision
        uses: anthropics/claude-code-action@e26577a930883943cf9d90885cd1e8da510078dd # beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          
          direct_prompt: |
            # AI Merge Decision Analysis
            
            You are an AI merge decider for the gitplus repository. Your primary job is to synthesize the **Claude Code review findings** with CI/CD results to make a **PASS/FAIL decision** on whether this PR should be merged.
            
            ## CRITICAL: Decision Hierarchy
            
            The **Claude Code review action has already performed expert code analysis**. Your decision hierarchy:
            
            1. **Claude Code Review Says No/Has Concerns** ‚Üí **AUTOMATIC FAIL** (regardless of CI status)
            2. **Claude Code Review Positive + CI Passes** ‚Üí **PASS**
            3. **Claude Code Review Positive + CI Fails** ‚Üí **FAIL** (fix CI first)
            4. **Claude Code Review Neutral/None + CI Passes** ‚Üí **PASS**
            5. **Any Critical CI Failures** ‚Üí **FAIL**
            
            ## Current Context
            
            **CI Workflow Results (from GitHub API):**
            - Overall CI Status: ${{ env.CI_OVERALL_STATUS }}
            - All workflows checked: CI, PR Checks, Claude Code Review
            
            **Claude Review Sentiment:** ${{ env.CLAUDE_SENTIMENT }}
            **Target Branch:** ${{ github.event.pull_request.base.ref }}
            **PR Author:** ${{ github.event.pull_request.user.login }} (${{ github.event.pull_request.author_association }})
            
            ## Context Files Available
            
            **Priority order for analysis:**
            1. `.github/context/claude-review.json` - **MOST IMPORTANT** - Claude's expert code review
            2. `.github/context/claude-comments.json` - Claude's additional feedback  
            3. `.github/context/claude-review-analysis.txt` - Claude review summary
            4. `.github/context/ci-results.txt` - CI job results and analysis
            5. `.github/context/pr-info.txt` - PR details and description
            6. `.github/context/commits.txt` - Commit history
            7. `.github/context/file-changes.txt` - File changes and statistics
            
            ## Required Output Format
            
            You MUST provide your decision in this exact format:
            
            ```
            ## ü§ñ AI Merge Decision: [PASS/FAIL]
            
            **Target Branch:** ${{ github.event.pull_request.base.ref }}
            **Decision Basis:** [Claude Code Review + CI Status / CI Status Only]  
            **Claude Review Sentiment:** ${{ env.CLAUDE_SENTIMENT }}
            
            ### üéØ Claude Code Review Analysis
            **Status:** [Found/Not Found]
            **Recommendation:** [Positive/Negative/Neutral/Not Available]
            **Key Findings:** [Summary of Claude's expert analysis or "No Claude review available"]
            
            ### üîß CI/CD Status Summary
            **Overall:** ${{ env.CI_OVERALL_STATUS }}
            **Workflows Checked:** CI, PR Checks, Claude Code Review
            **Details:** [See context files for specific workflow results]
            
            ### ‚úÖ Strengths
            - [List positive aspects of this PR]
            
            ### ‚ö†Ô∏è Issues Found
            - [List any issues with severity levels]
            
            ### üîß Required Actions (if FAIL)
            1. [Specific, actionable step to fix issue 1]
            2. [Specific, actionable step to fix issue 2]
            3. [etc.]
            
            ### üí° Final Recommendation
            [Clear explanation of why this should/shouldn't merge, emphasizing how you weighted Claude Code review findings vs CI results]
            
            ---
            *Decision made by Claude AI ‚Ä¢ Integrating expert Claude Code review ‚Ä¢ PR #${{ github.event.pull_request.number }}*
            ```
            
            ## Decision Rules
            - **FAIL if**: Claude Code review recommends against merging OR critical CI failures
            - **PASS if**: Claude Code review is positive/neutral AND CI passes  
            - **Always respect Claude Code's expert technical analysis** - don't override its code quality findings
            - Provide specific, actionable remediation steps for failures
            - Consider the author's experience level (first-time contributors get more guidance)
            
            **Remember: The Claude Code review has done the deep technical code analysis. Your job is to synthesize that expert opinion with CI/CD results for the final merge decision.**

      - name: Set merge decision status
        run: |
          # Extract decision from Claude's response
          if echo "${{ steps.merge-decision.outputs.claude_response }}" | grep -q "AI Merge Decision: PASS"; then
            echo "MERGE_DECISION=pass" >> $GITHUB_ENV
            echo "‚úÖ AI Merge Decision: PASS"
          elif echo "${{ steps.merge-decision.outputs.claude_response }}" | grep -q "AI Merge Decision: FAIL"; then
            echo "MERGE_DECISION=fail" >> $GITHUB_ENV
            echo "‚ùå AI Merge Decision: FAIL"
            exit 1
          else
            echo "‚ö†Ô∏è Could not determine merge decision from AI response"
            echo "MERGE_DECISION=fail" >> $GITHUB_ENV
            exit 1
          fi

      - name: Update PR labels based on decision
        if: always()
        run: |
          if [ "${{ env.MERGE_DECISION }}" = "pass" ]; then
            gh pr edit ${{ github.event.pull_request.number }} --add-label "ready-to-merge" --remove-label "needs-changes" || true
          else
            gh pr edit ${{ github.event.pull_request.number }} --add-label "needs-changes" --remove-label "ready-to-merge" || true
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary job that branch protection will check - this is what branch protection waits for
  merge-decision-summary:
    runs-on: ubuntu-latest
    needs: [ai-merge-decision]
    if: always()
    steps:
      - name: Merge Decision Summary
        run: |
          if [ "${{ needs.ai-merge-decision.result }}" = "success" ]; then
            echo "‚úÖ AI Merge Decision: APPROVED"
            echo "This PR has been approved by the AI merge decider and is ready to merge."
            echo "The AI analyzed Claude Code review findings and all CI results to make this decision."
          else
            echo "‚ùå AI Merge Decision: REJECTED"  
            echo "This PR has been rejected by the AI merge decider."
            echo "Please check the AI analysis comment for detailed feedback and required actions."
            echo "The decision was based on Claude Code review findings and/or CI failures."
            exit 1
          fi